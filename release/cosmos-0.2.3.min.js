!function(t,e){"function"==typeof define&&define.amd?define(["react","lodash","jquery"],e):"object"==typeof exports?module.exports=e(require("react"),require("lodash"),require("jquery")):t.Cosmos=e(t.React,t._,t.$)}(this,function(t,e,n){var o=function(t){var n=o.getComponentByName(t.component,t.componentLookup);if(!e.isFunction(n))throw new Error("Invalid component: "+t.component);return n(t)};return e.extend(o,{mixins:{},components:{},transitions:{},start:function(t){return new this.Router(t)},render:function(e,n,o){var i=this(e);return n?t.renderComponent(i,n,o):t.renderComponentToString(i)},getComponentByName:function(t,e){return"function"==typeof e?e(t):this.components[t]}}),o.Router=function(t){this.options=e.extend({props:o.url.getParams(),container:document.body},t),e.isEmpty(this.options.props)&&this.options.defaultProps&&(this.options.props=this.options.defaultProps),this.container=this.options.container,this._onPopState=this._onPopState.bind(this),this._bindPopStateEvent(),this._load(this.options.props,window.location.href)},e.extend(o.Router,{prototype:{stop:function(){this._unbindPopStateEvent()},goTo:function(t){if(!o.url.isPushStateSupported())return window.location=t,void 0;this.rootComponent&&this._replaceHistoryState(this.rootComponent.generateSnapshot(),this._currentHref);var e=t.split("?").pop(),n=o.serialize.getPropsFromQueryString(e);this._load(n,t),this._pushHistoryState(n,t)},_load:function(t,e){this.rootComponent=o.render(t,this.container),this._currentHref=e},_bindPopStateEvent:function(){window.addEventListener("popstate",this._onPopState)},_unbindPopStateEvent:function(){window.removeEventListener("popstate",this._onPopState)},_onPopState:function(t){t.state&&this._load(t.state,window.location.href)},_replaceHistoryState:function(t,e){window.history.replaceState(t,"",e)},_pushHistoryState:function(t,e){window.history.pushState(t,"",e)}}}),o.serialize={getPropsFromQueryString:function(t){var e={};if(t.length)for(var n,o,i,s=t.split("&"),r=0;r<s.length;r++){n=s[r].split("="),o=n[0],i=decodeURIComponent(n[1]);try{i=JSON.parse(i)}catch(a){}e[o]=i}return e},getQueryStringFromProps:function(t){var e,n=[];for(var o in t){if(e=t[o],"object"==typeof e)try{e=JSON.stringify(e)}catch(i){continue}n.push(o+"="+encodeURIComponent(e))}return n.join("&")}},o.url={getParams:function(){return o.serialize.getPropsFromQueryString(window.location.search.substr(1))},isPushStateSupported:function(){return!!window.history.pushState}},function(t,e){t.mixins.AnimationLoop={startAnimationLoop:function(){this._clearAnimation(),this._nextFrame(),this.setState({animationLoopRunning:!0})},stopAnimationLoop:function(){this._clearAnimation(),this.setState({animationLoopRunning:!1})},componentDidMount:function(){this._loadAnimationState(this.state)},componentWillReceiveProps:function(t){t.state&&this._loadAnimationState(t.state)},componentWillUnmount:function(){this._clearAnimation()},_loadAnimationState:function(t){t&&void 0!==t.animationLoopRunning&&(t.animationLoopRunning?this.startAnimationLoop():this.stopAnimationLoop())},_nextFrame:function(){this._prevTime=Date.now(),this._animationRequestId=n(this._animationCallback)},_clearAnimation:function(){this._animationRequestId&&(o(this._animationRequestId),this._animationRequestId=null)},_animationCallback:function(){if("function"==typeof this.onFrame){var t=Date.now(),e=t-this._prevTime,n=1e3/60;this.onFrame(e/n),this._animationRequestId&&this._nextFrame()}}};var n=e.requestAnimationFrame||e.webkitRequestAnimationFrame||e.mozRequestAnimationFrame||function(t){return e.setTimeout(t,1e3/60)},o=e.cancelAnimationFrame||e.webkitCancelAnimationFrame||e.mozCancelAnimationFrame||function(t){e.clearTimeout(t)}}(o,this),o.mixins.ClassName={getClassName:function(t){return void 0!==this.props.className?this.props.className:t}},o.mixins.DataFetch={fetchDataFromServer:function(t,o){this.setState({isFetchingData:!0});var i=n.ajax({url:t,type:"GET",dataType:"json",complete:function(){this.xhrRequests=e.without(this.xhrRequests,i)}.bind(this),success:o,error:function(e,n,o){this._ignoreXhrRequestCallbacks||(this.setState({isFetchingData:!1}),console.error(t,n,o.toString()))}.bind(this)});this.xhrRequests.push(i)},receiveDataFromServer:function(t){this.setState({isFetchingData:!1,data:t})},_resetData:function(t){var e="function"==typeof this.getDataUrl?this.getDataUrl(t):t.dataUrl;this.clearDataRequests(),e&&(this.fetchDataFromServer(e,this.receiveDataFromServer),t.pollInterval&&(this.pollInterval=setInterval(function(){this.fetchDataFromServer(e,this.receiveDataFromServer)}.bind(this),t.pollInterval)))},refreshData:function(){this._resetData(this.props)},clearDataRequests:function(){for(;!e.isEmpty(this.xhrRequests);)this.xhrRequests.pop().abort();this.pollInterval&&clearInterval(this.pollInterval)},getDefaultProps:function(){return{pollInterval:0}},componentWillMount:function(){this.xhrRequests=[],this._resetData(this.props)},componentWillReceiveProps:function(t){this.props.dataUrl!==t.dataUrl&&this._resetData(t)},componentWillUnmount:function(){this._ignoreXhrRequestCallbacks=!0,this.clearDataRequests()}},o.mixins.PersistState={generateSnapshot:function(t){var n,o={},i={};for(var s in this.props)n=this.props[s],"__owner__"!=s&&"state"!=s&&"ref"!=s&&(o[s]=n);return o.state=e.cloneDeep(this.state)||{},t&&(e.each(this.refs,function(t,n){i[n]="function"==typeof t.generateSnapshot?t.generateSnapshot(!0).state:e.cloneDeep(t.state)||{}}),e.isEmpty(i)||(o.state.children=i)),o},loadChild:function(){var t=this.getChildProps.apply(this,arguments);if(t)try{return o(t)}catch(e){console.error(e)}return null},getChildProps:function(t){for(var e=[],n=1;n<arguments.length;++n)e[n-1]=arguments[n];var o=this.children[t].apply(this,e);return o?(o.ref||(o.ref=t),this._childSnapshots&&this._childSnapshots[t]&&(o.state=this._childSnapshots[t],delete this._childSnapshots[t]),this.props.componentLookup&&(o.componentLookup=this.props.componentLookup),o):void 0},loadStateSnapshot:function(t){t.children&&(this._childSnapshots=t.children,delete t.children),this.replaceState(e.cloneDeep(t))},componentWillMount:function(){this.props.state&&this.loadStateSnapshot(this.props.state)},componentWillReceiveProps:function(t){t.state&&this.loadStateSnapshot(t.state)}},o.mixins.Url={getUrlFromProps:function(t){return"?"+o.serialize.getQueryStringFromProps(t)},routeLink:function(t){t.preventDefault(),App.router.goTo(t.currentTarget.getAttribute("href"))}},o});